generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Usuario {
  id            Int         @id @default(autoincrement())
  nombre        String
  email         String      @unique
  password      String?
  rol           Rol
  creadoEn      DateTime    @default(now())
  actualizadoEn DateTime    @updatedAt
  director      Director?
  empresa       Empresa?
  estudiante    Estudiante?
}

model Director {
  id                Int        @id @default(autoincrement())
  usuarioId         Int        @unique
  programaId        Int?       @unique
  Facultad          String?
  usuario           Usuario    @relation(fields: [usuarioId], references: [id])
  programa          Programa?  @relation(fields: [programaId], references: [id])
  convenios         Convenio[]
  reportes          Reporte[]
  vacantesValidadas Vacante[]
  empresas          Empresa[]
  documentos        Documento[]
  conversaciones    Conversacion[]
}

model Programa {
  id         Int        @id @default(autoincrement())
  nombre     String     @unique
  facultad   String
  directores Director[]
}

model Estudiante {
  id            Int           @id @default(autoincrement())
  usuarioId     Int           @unique
  habilidades   String?
  perfil        String?
  usuario       Usuario       @relation(fields: [usuarioId], references: [id])
  practicas     Practica[]
  postulaciones Postulacion[] // postulaciones del estudiante
}

model Empresa {
  id           Int           @id @default(autoincrement())
  usuarioId    Int           @unique
  usuario      Usuario       @relation(fields: [usuarioId], references: [id])
  nit          String        @unique
  telefono     String?
  direccion    String?
  sector       String?
  descripcion  String?
  estado       EstadoEmpresa @default(PENDIENTE)
  habilitada   Boolean       @default(false) // solo true si tiene convenio activo
  directorId   Int?
  director     Director?     @relation(fields: [directorId], references: [id])
  createdAt    DateTime      @default(now())
  convenios    Convenio[]
  vacantes     Vacante[]
  evaluaciones Evaluacion[]
  representanteLegal RepresentanteLegal?
  conversaciones     Conversacion[]
}

enum EstadoEmpresa {
  PENDIENTE
  APROBADA
  HABILITADA
  INHABILITADA
  RECHAZADA
}

model Convenio {
  id            Int            @id @default(autoincrement())
  empresaId     Int
  directorId    Int?
  nombre        String
  descripcion   String?
  tipo          TipoConvenio   @default(MACRO)
  fechaInicio   DateTime?
  fechaFin      DateTime?
  estado        EstadoConvenio @default(EN_REVISION)
  archivoUrl    String?
  observaciones String?
  version       Int            @default(1)
  creadoEn      DateTime       @default(now())
  actualizadoEn DateTime       @updatedAt

  // Relaciones
  empresa    Empresa            @relation(fields: [empresaId], references: [id])
  director   Director?           @relation(fields: [directorId], references: [id])
  revisiones RevisionConvenio[]
  documentos Documento[]
  vacantes   Vacante[]

  // Auto-relación (marco ↔ específicos)
  macroConvenioId Int?
  macroConvenio   Convenio?  @relation("SubConvenios", fields: [macroConvenioId], references: [id])
  subConvenios    Convenio[] @relation("SubConvenios")

  @@index([macroConvenioId])
}

model RevisionConvenio {
  id         Int          @id @default(autoincrement())
  convenioId Int
  autorId    Int? // usuario (empresa o director)
  mensaje    String
  fecha      DateTime     @default(now())
  tipo       TipoRevision
  convenio   Convenio     @relation(fields: [convenioId], references: [id])
}

enum TipoRevision {
  EMPRESA
  DIRECTOR
  DECANATURA
}

enum TipoConvenio {
  MACRO
  ESPECIFICO
}

enum EstadoConvenio {
  PENDIENTE_FIRMA
  PENDIENTE_REVISION
  EN_REVISION
  APROBADO
  RECHAZADO
  VENCIDO
}

model Vacante {
  id                  Int           @id @default(autoincrement())
  empresaId           Int
  convenioId          Int? // convenio activo que la respalda
  directorValidaId    Int?
  titulo              String
  modalidad           Modalidad
  descripcion         String
  area                String
  ciudad              String?
  habilidadesBlandas  String?
  habilidadesTecnicas String?
  estado              EstadoGeneral @default(PENDIENTE)
  creadaEn            DateTime      @default(now())
  actualizadaEn       DateTime      @default(now()) @updatedAt
  empresa             Empresa       @relation(fields: [empresaId], references: [id])
  convenio            Convenio?     @relation(fields: [convenioId], references: [id])
  directorValida      Director?     @relation(fields: [directorValidaId], references: [id])
  practicas           Practica[]
  postulaciones       Postulacion[]
}

enum Modalidad {
  PRESENCIAL
  REMOTO
  HIBRIDO
}

enum EstadoGeneral {
  PENDIENTE
  APROBADA
  RECHAZADA
  INACTIVA
}

model Postulacion {
  id           Int               @id @default(autoincrement())
  estudianteId Int
  vacanteId    Int
  estado       EstadoPostulacion @default(EN_REVISION)
  fechaPostula DateTime          @default(now())
  comentario   String?
  estudiante   Estudiante        @relation(fields: [estudianteId], references: [id])
  vacante      Vacante           @relation(fields: [vacanteId], references: [id])
}

enum EstadoPostulacion {
  EN_REVISION
  ACEPTADA
  RECHAZADA
  CANCELADA
}

model Practica {
  id           Int            @id @default(autoincrement())
  estudianteId Int
  vacanteId    Int
  estado       EstadoPractica @default(EN_PROCESO)
  inicio       DateTime?
  fin          DateTime?
  evaluacion   Evaluacion?
  estudiante   Estudiante     @relation(fields: [estudianteId], references: [id])
  vacante      Vacante        @relation(fields: [vacanteId], references: [id])
}

enum EstadoPractica {
  EN_PROCESO
  FINALIZADA
  CANCELADA
}

model Evaluacion {
  id           Int      @id @default(autoincrement())
  practicaId   Int      @unique
  empresaId    Int
  calificacion Int
  observacion  String?
  fecha        DateTime @default(now())
  empresa      Empresa  @relation(fields: [empresaId], references: [id])
  practica     Practica @relation(fields: [practicaId], references: [id])
}

model Reporte {
  id          Int      @id @default(autoincrement())
  directorId  Int
  titulo      String
  descripcion String?
  fecha       DateTime @default(now())
  director    Director @relation(fields: [directorId], references: [id])
}

model Documento {
  id           Int       @id @default(autoincrement())
  titulo       String
  descripcion  String?
  categoria    TipoDocumento @default(GENERAL)
  archivoUrl   String
  publicId     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  directorId   Int
  director     Director  @relation(fields: [directorId], references: [id], onDelete: Cascade)
  convenioId   Int?
  Convenio     Convenio? @relation(fields: [convenioId], references: [id])
}

enum TipoDocumento {
  GENERAL
  CONVENIO_PLANTILLA
  CONVENIO_EMPRESA
  ESTUDIANTE
  EMPRESA
}

model RepresentanteLegal {
  id              Int      @id @default(autoincrement())
  empresaId       Int      @unique
  nombreCompleto  String
  tipoDocumento   String
  numeroDocumento String   @unique
  cargo           String
  telefono        String?
  email           String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  empresa         Empresa  @relation(fields: [empresaId], references: [id], onDelete: Cascade)
}

model Conversacion {
  id         Int       @id @default(autoincrement())
  empresaId  Int
  directorId Int
  titulo     String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  empresa    Empresa   @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  director   Director  @relation(fields: [directorId], references: [id], onDelete: Cascade)
  mensajes   Mensaje[]

  @@unique([empresaId, directorId])
  @@index([empresaId])
  @@index([directorId])
}

model Mensaje {
  id              Int              @id @default(autoincrement())
  conversacionId  Int
  remitenteId     Int
  remitenteRol    Rol
  contenido       String?
  createdAt       DateTime         @default(now())
  conversacion    Conversacion     @relation(fields: [conversacionId], references: [id], onDelete: Cascade)
  archivos        ArchivoMensaje[]

  @@index([conversacionId])
  @@index([createdAt])
}

model ArchivoMensaje {
  id           Int      @id @default(autoincrement())
  mensajeId    Int
  nombreArchivo String
  archivoUrl   String
  publicId     String?
  mimeType     String?
  fileSize     Int?
  createdAt    DateTime @default(now())
  mensaje      Mensaje  @relation(fields: [mensajeId], references: [id], onDelete: Cascade)

  @@index([mensajeId])
}

enum Rol {
  ADMIN
  DIRECTOR
  ESTUDIANTE
  EMPRESA
}

model Notificacion {
  id              Int                   @id @default(autoincrement())
  tipo            TipoNotificacion
  titulo          String
  mensaje         String
  prioridad       PrioridadNotificacion @default(MEDIA)
  destinatarioId  Int
  destinatarioRol Rol
  leida           Boolean               @default(false)
  data            Json? // Información adicional específica del tipo de notificación
  creadaEn        DateTime              @default(now())
  actualizadaEn   DateTime              @updatedAt

  @@index([destinatarioId, leida])
  @@index([tipo])
  @@index([creadaEn])
}

enum TipoNotificacion {
  CONVENIO_PROXIMO_VENCER
  CONVENIO_VENCIDO
  NUEVA_SOLICITUD_VACANTE
  VACANTE_APROBADA
  VACANTE_RECHAZADA
}

enum PrioridadNotificacion {
  BAJA
  MEDIA
  ALTA
  URGENTE
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Usuario {
  id            Int         @id @default(autoincrement())
  nombre        String
  email         String      @unique
  password      String?
  rol           Rol
  creadoEn      DateTime    @default(now())
  actualizadoEn DateTime    @updatedAt
  director      Director?
  empresa       Empresa?
  estudiante    Estudiante?
}

model Director {
  id                Int             @id @default(autoincrement())
  usuarioId         Int             @unique
  programaId        Int?            @unique
  Facultad          String?
  usuario           Usuario         @relation(fields: [usuarioId], references: [id])
  programa          Programa?       @relation(fields: [programaId], references: [id])
  convenios         Convenio[]
  reportes          Reporte[]
  vacantesValidadas Vacante[]
  empresas          Empresa[]
  documentos        Documento[]
  conversaciones    Conversacion[]
}

model Programa {
  id         Int        @id @default(autoincrement())
  nombre     String     @unique
  facultad   String
  directores Director[]
}

model Estudiante {
  id          Int        @id @default(autoincrement())
  usuarioId   Int        @unique
  habilidades String?
  perfil      String?
  usuario     Usuario    @relation(fields: [usuarioId], references: [id])
  practicas   Practica[]
}

model Empresa {
  id                 Int                  @id @default(autoincrement())
  usuarioId          Int                  @unique
  usuario            Usuario              @relation(fields: [usuarioId], references: [id])
  nit                String               @unique
  telefono           String?
  direccion          String?
  sector             String?
  descripcion        String?
  estado             EstadoGeneral        @default(PENDIENTE)
  directorId         Int?
  director           Director?            @relation(fields: [directorId], references: [id])
  createdAt          DateTime             @default(now())
  convenios          Convenio[]
  vacantes           Vacante[]
  evaluaciones       Evaluacion[]
  representanteLegal RepresentanteLegal?
  conversaciones     Conversacion[]
}

model Convenio {
  id            Int            @id @default(autoincrement())
  empresaId     Int
  directorId    Int
  nombre        String
  estado        EstadoConvenio
  actualizadoEn DateTime       @updatedAt
  archivoUrl    String?
  director      Director       @relation(fields: [directorId], references: [id])
  empresa       Empresa        @relation(fields: [empresaId], references: [id])
}

model Vacante {
  id                  Int             @id @default(autoincrement())
  empresaId           Int
  directorValidaId    Int?
  titulo              String
  modalidad           Modalidad
  descripcion         String
  area                String
  habilidadesBlandas  String?         
  habilidadesTecnicas String?
  estado              EstadoGeneral   @default(PENDIENTE)
  creadaEn            DateTime        @default(now())
  practicas           Practica[]
  directorValida      Director?     @relation(fields: [directorValidaId], references: [id])
  empresa             Empresa       @relation(fields: [empresaId], references: [id])
}

enum Modalidad {
  PRESENCIAL
  REMOTO
  HIBRIDO
}

enum EstadoGeneral {
  PENDIENTE
  APROBADA
  RECHAZADA
  INACTIVA
}

model Practica {
  id           Int            @id @default(autoincrement())
  estudianteId Int
  vacanteId    Int
  estado       EstadoPractica @default(EN_PROCESO)
  inicio       DateTime?
  fin          DateTime?
  evaluacion   Evaluacion?
  estudiante   Estudiante     @relation(fields: [estudianteId], references: [id])
  vacante      Vacante        @relation(fields: [vacanteId], references: [id])
}

model Evaluacion {
  id           Int      @id @default(autoincrement())
  practicaId   Int      @unique
  empresaId    Int
  calificacion Int
  observacion  String?
  fecha        DateTime @default(now())
  empresa      Empresa  @relation(fields: [empresaId], references: [id])
  practica     Practica @relation(fields: [practicaId], references: [id])
}

model Reporte {
  id          Int      @id @default(autoincrement())
  directorId  Int
  titulo      String
  descripcion String?
  fecha       DateTime @default(now())
  director    Director @relation(fields: [directorId], references: [id])
}

model Documento {
  id             Int       @id @default(autoincrement())
  titulo         String
  descripcion    String?
  archivoUrl     String
  publicId       String?
  originalName   String?
  mimeType       String?
  fileSize       Int?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  directorId     Int
  director       Director  @relation(fields: [directorId], references: [id], onDelete: Cascade)
}

model RepresentanteLegal {
  id              Int      @id @default(autoincrement())
  empresaId       Int      @unique
  nombreCompleto  String
  tipoDocumento   String
  numeroDocumento String   @unique
  cargo           String
  telefono        String?
  email           String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  empresa         Empresa  @relation(fields: [empresaId], references: [id], onDelete: Cascade)
}

model Conversacion {
  id         Int       @id @default(autoincrement())
  empresaId  Int
  directorId Int
  titulo     String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  empresa    Empresa   @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  director   Director  @relation(fields: [directorId], references: [id], onDelete: Cascade)
  mensajes   Mensaje[]

  @@unique([empresaId, directorId])
  @@index([empresaId])
  @@index([directorId])
}

model Mensaje {
  id              Int              @id @default(autoincrement())
  conversacionId  Int
  remitenteId     Int
  remitenteRol    Rol
  contenido       String?
  createdAt       DateTime         @default(now())
  conversacion    Conversacion     @relation(fields: [conversacionId], references: [id], onDelete: Cascade)
  archivos        ArchivoMensaje[]

  @@index([conversacionId])
  @@index([createdAt])
}

model ArchivoMensaje {
  id           Int      @id @default(autoincrement())
  mensajeId    Int
  nombreArchivo String
  archivoUrl   String
  publicId     String?
  mimeType     String?
  fileSize     Int?
  createdAt    DateTime @default(now())
  mensaje      Mensaje  @relation(fields: [mensajeId], references: [id], onDelete: Cascade)

  @@index([mensajeId])
}

enum Rol {
  ADMIN
  DIRECTOR
  ESTUDIANTE
  EMPRESA
}

enum EstadoPractica {
  EN_PROCESO
  FINALIZADA
  CANCELADA
}

enum EstadoConvenio {
  ACTIVO
  PENDIENTE
  CANCELADO
  RECHAZADO
}

